<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gestión de Ventas y Metas | App Local PWA</title>

  <!-- Tailwind CDN (se cachea vía SW) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Manifest: se inyecta dinámicamente con Blob más abajo -->
  <link id="dynamic-manifest" rel="manifest" href="">

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#4F46E5',
            secondary: '#10B981',
            accent: '#F59E0B',
          },
          fontFamily: { sans: ['Inter', 'sans-serif'] },
        },
      },
    };
  </script>

  <!-- Lucide desde CDN (se cachea vía SW) -->
  <script type="module">
    import { createIcons, Home, Target, TrendingUp, Users, Settings, Plus, Save, Trash2, Edit, Check, X } from 'https://unpkg.com/lucide@latest';
    window.icons = { Home, Target, TrendingUp, Users, Settings, Plus, Save, Trash2, Edit, Check, X };
    window.createIcons = () => createIcons({ icons: window.icons });
  </script>

  <style>
    body { background-color: #f3f4f6; }
    .container-app { max-width: 100vw; min-height: 100vh; padding-bottom: 72px; }
    #nav-bar { position: fixed; bottom: 0; left: 0; right: 0; z-index: 50; background-color: white; box-shadow: 0 -4px 6px -1px rgba(0,0,0,0.1); }
    .nav-item { display:flex; flex-direction:column; align-items:center; justify-content:center; padding:8px 4px; cursor:pointer; transition: color .2s, background-color .2s; }
    .nav-item.active { color:#4F46E5; }
    .modal { transition: opacity .3s ease-in-out, visibility .3s ease-in-out; }
    .modal-content { transform: translateY(20px); transition: transform .3s ease-in-out; }
    .modal.open .modal-content { transform: translateY(0); }
    .table-scroll { overflow-x:auto; -webkit-overflow-scrolling:touch; }
  </style>
</head>
<body class="font-sans">
  <div id="app" class="container-app mx-auto p-4 md:p-6">
    <header class="mb-6">
      <h1 class="text-3xl font-bold text-gray-800 text-center md:text-left">Gestión de Ventas Local</h1>
      <p class="text-gray-600 text-center md:text-left">Seguimiento de Metas y Productividad</p>
    </header>

    <main id="content" class="bg-white p-4 rounded-xl shadow-lg"></main>

    <!-- Modal mensajes -->
    <div id="message-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 opacity-0 invisible" onclick="app.closeModal()">
      <div class="modal-content bg-white p-6 rounded-lg shadow-2xl w-full max-w-sm" onclick="event.stopPropagation()">
        <h3 id="message-title" class="text-xl font-semibold text-gray-800 mb-3"></h3>
        <p id="message-body" class="text-gray-600 mb-6"></p>
        <div class="flex justify-end">
          <button onclick="app.closeModal()" class="px-4 py-2 bg-primary text-white font-medium rounded-lg hover:bg-indigo-700 transition duration-150">Aceptar</button>
        </div>
      </div>
    </div>

    <!-- Overlay carga -->
    <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 opacity-0 invisible transition duration-300">
      <div class="flex flex-col items-center">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary"></div>
        <p class="mt-4 text-white text-lg">Sincronizando...</p>
      </div>
    </div>
  </div>

  <!-- Nav inferior -->
  <nav id="nav-bar" class="flex justify-around">
    <div class="nav-item active" data-view="dashboard" onclick="app.renderView('dashboard')">
      <i data-lucide="home" class="w-5 h-5"></i><span class="text-xs mt-1">Tablero</span>
    </div>
    <div class="nav-item" data-view="goals" onclick="app.renderView('goals')">
      <i data-lucide="target" class="w-5 h-5"></i><span class="text-xs mt-1">Metas</span>
    </div>
    <div class="nav-item" data-view="sales" onclick="app.renderView('sales')">
      <i data-lucide="trending-up" class="w-5 h-5"></i><span class="text-xs mt-1">Ventas</span>
    </div>
    <div class="nav-item" data-view="productivity" onclick="app.renderView('productivity')">
      <i data-lucide="users" class="w-5 h-5"></i><span class="text-xs mt-1">Productividad</span>
    </div>
    <div class="nav-item" data-view="settings" onclick="app.renderView('settings')">
      <i data-lucide="settings" class="w-5 h-5"></i><span class="text-xs mt-1">Config</span>
    </div>
  </nav>
<!-- SW + Manifest (Blob) y App -->
  <script type="module">
    // --- Manifest dinámico (Blob) ---
    const manifestData = {
      name: "Gestión de Ventas",
      short_name: "VentasApp",
      description: "App Local de Seguimiento de Metas y Ventas.",
      start_url: "./",
      display: "standalone",
      background_color: "#f3f4f6",
      theme_color: "#4F46E5",
      orientation: "portrait",
      icons: [
        { src: "https://placehold.co/192x192/4F46E5/ffffff?text=V", sizes: "192x192", type: "image/png" },
        { src: "https://placehold.co/512x512/4F46E5/ffffff?text=V", sizes: "512x512", type: "image/png" }
      ]
    };
    const manifestBlob = new Blob([JSON.stringify(manifestData)], { type: 'application/manifest+json' });
    const manifestUrl = URL.createObjectURL(manifestBlob);
    const manifestLink = document.getElementById('dynamic-manifest');
    manifestLink.href = manifestUrl;

    // --- Service Worker dinámico (Blob) ---
    const CACHE_NAME = 'sales-app-v1';
    const CORE_ASSETS = [
      './',
      manifestUrl,               // manifest blob
      'https://cdn.tailwindcss.com',
      'https://unpkg.com/lucide@latest'
    ];
    const swCode = `
      const CACHE_NAME = '${CACHE_NAME}';
      const CORE_ASSETS = ${JSON.stringify(CORE_ASSETS)};
      self.addEventListener('install', (event) => {
        self.skipWaiting();
        event.waitUntil(caches.open(CACHE_NAME).then(cache => cache.addAll(CORE_ASSETS)));
      });
      self.addEventListener('activate', (event) => {
        event.waitUntil(
          caches.keys().then(names =>
            Promise.all(names.filter(n => n !== CACHE_NAME).map(n => caches.delete(n)))
          ).then(() => self.clients.claim())
        );
      });
      self.addEventListener('fetch', (event) => {
        const req = event.request;
        event.respondWith(
          caches.match(req).then(cached => {
            if (cached) return cached;
            return fetch(req).then(resp => {
              if (req.method === 'GET' && resp.status === 200) {
                const clone = resp.clone();
                caches.open(CACHE_NAME).then(cache => cache.put(req, clone));
              }
              return resp;
            }).catch(() => cached || new Response('', { status: 504 }));
          })
        );
      });
    `;
    async function registerSW() {
      if (!('serviceWorker' in navigator)) return false;
      const swBlob = new Blob([swCode], { type: 'application/javascript' });
      const swUrl = URL.createObjectURL(swBlob);
      try {
        const reg = await navigator.serviceWorker.register(swUrl);
        console.log('SW registrado:', reg.scope);
        return true;
      } catch (e) {
        console.warn('SW no se pudo registrar:', e);
        return false;
      }
    }
    async function prewarmCache(urls = []) {
      try {
        await Promise.allSettled(urls.map(u => fetch(u).catch(() => null)));
      } catch (_) {}
    }

    // --- Datos comunes ---
    const DB_NAME = 'SalesDB';
    const DB_VERSION = 1;
    const STORE_NAMES = ['config', 'branches', 'promoters', 'goals', 'sales'];
    const PRODUCTS = ['amigo kit', 'chip cero', 'chip expréss', 'portabilidad', 'boletín 63'];
    const MONTHS = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];

    class SalesApp {
      constructor() {
        this.db = null;
        this.elements = {
          content: document.getElementById('content'),
          messageModal: document.getElementById('message-modal'),
          loadingOverlay: document.getElementById('loading-overlay')
        };
        this.state = { currentView: 'dashboard', gistId: '', gistToken: '', isReady: false };
      }

      // UI
      showMessage(title, body) {
        document.getElementById('message-title').textContent = title;
        document.getElementById('message-body').innerHTML = body;
        this.elements.messageModal.classList.add('open','opacity-100','visible');
      }
      closeModal() {
        this.elements.messageModal.classList.remove('open','opacity-100','visible');
        this.elements.messageModal.classList.add('opacity-0','invisible');
      }
      setLoading(isLoading) {
        const el = this.elements.loadingOverlay;
        if (isLoading) { el.classList.remove('opacity-0','invisible'); el.classList.add('opacity-100','visible'); }
        else { el.classList.remove('opacity-100','visible'); el.classList.add('opacity-0','invisible'); }
      }

      renderView(viewName) {
        if (!this.state.isReady) return;
        this.state.currentView = viewName;
        document.querySelectorAll('.nav-item').forEach(item => {
          item.classList.toggle('active', item.getAttribute('data-view') === viewName);
        });
        this.elements.content.innerHTML = `<h2 class="text-2xl font-semibold text-gray-700 mb-4">${this.getViewTitle(viewName)}</h2><div id="view-container"></div>`;
        const container = document.getElementById('view-container');
switch (viewName) {
          case 'dashboard': this.renderDashboard(container); break;
          case 'goals': this.renderGoals(container); break;
          case 'sales': this.renderSales(container); break;
          case 'productivity': this.renderProductivity(container); break;
          case 'settings': this.renderSettings(container); break;
        }
        window.createIcons();
      }

      getViewTitle(viewName) {
        const titles = {
          dashboard: 'Tablero de Avance de Metas',
          goals: 'Metas de Venta Mensuales',
          sales: 'Registro de Ventas Diarias',
          productivity: 'Productividad de Promotores',
          settings: 'Configuración y Sincronización'
        };
        return titles[viewName] || 'Vista';
      }

      // IndexedDB
      async initDB() {
        return new Promise((resolve) => {
          try {
            const request = indexedDB.open(DB_NAME, DB_VERSION);
            request.onupgradeneeded = (event) => {
              const db = event.target.result;
              STORE_NAMES.forEach(name => {
                if (!db.objectStoreNames.contains(name)) db.createObjectStore(name, { keyPath: 'id', autoIncrement: false });
              });
            };
            request.onsuccess = (event) => { this.db = event.target.result; resolve(true); };
            request.onerror = () => { console.warn('IndexedDB bloqueada, modo simulado.'); this.db = null; resolve(false); };
          } catch (e) { console.warn('IndexedDB no disponible.', e); this.db = null; resolve(false); }
        });
      }
      async save(storeName, data) {
        if (!this.db) return;
        return new Promise((resolve, reject) => {
          if (!data.id) { data.id = crypto.randomUUID(); data.createdAt = Date.now(); } else { data.updatedAt = Date.now(); }
          const tx = this.db.transaction([storeName], 'readwrite');
          const store = tx.objectStore(storeName);
          const req = store.put(data);
          req.onsuccess = () => resolve(data.id);
          req.onerror = (e) => reject(e.target.error);
        });
      }
      async getAll(storeName) {
        if (!this.db) return [];
        return new Promise((resolve, reject) => {
          const tx = this.db.transaction([storeName], 'readonly');
          const store = tx.objectStore(storeName);
          const req = store.getAll();
          req.onsuccess = (e) => resolve(e.target.result);
          req.onerror = (e) => reject(e.target.error);
        });
      }
      async delete(storeName, id) {
        if (!this.db) return;
        return new Promise((resolve, reject) => {
          const tx = this.db.transaction([storeName], 'readwrite');
          const store = tx.objectStore(storeName);
          const req = store.delete(id);
          req.onsuccess = () => resolve();
          req.onerror = (e) => reject(e.target.error);
        });
      }
      async replaceAll(storeName, dataArray) {
        if (!this.db) return;
        return new Promise(async (resolve, reject) => {
          const tx = this.db.transaction([storeName], 'readwrite');
          const store = tx.objectStore(storeName);
          const clearReq = store.clear();
          clearReq.onerror = (e) => reject(e.target.error);
          clearReq.onsuccess = async () => {
            try {
              for (const d of dataArray) {
                const item = { ...d };
                if (!item.id) item.id = crypto.randomUUID();
                await new Promise((res, rej) => {
                  const addReq = store.add(item);
                  addReq.onsuccess = res;
                  addReq.onerror = (e) => rej(e.target.error);
                });
              }
              tx.oncomplete = () => resolve();
            } catch (err) { reject(err); }
          };
        });
      }

      // Config Gist local en DB y sincronización bajo demanda
      async loadGistConfigLocal() {
        const config = await this.getAll('config');
        const gistId = config.find(c => c.id === 'gistId')?.value || '';
        const gistToken = config.find(c => c.id === 'gistToken')?.value || '';
        this.state.gistId = gistId;
        this.state.gistToken = gistToken;
      }
      async saveGistConfig(gistId, gistToken) {
        await this.save('config', { id: 'gistId', value: gistId });
        await this.save('config', { id: 'gistToken', value: gistToken });
        this.state.gistId = gistId;
        this.state.gistToken = gistToken;
        this.showMessage("Configuración Guardada", "ID y Token de Gist guardados localmente.");
        this.renderView('settings');
      }
      async syncFromGist() {
        if (!this.state.gistId || !this.state.gistToken) {
          this.showMessage("Error de Sincronización", "Configure Gist ID y Token.");
          return;
        }
        this.setLoading(true);
        try {
          const resp = await fetch(`https://api.github.com/gists/${this.state.gistId}`, {
            headers: { 'Authorization': `token ${this.state.gistToken}`, 'Accept': 'application/vnd.github.v3+json' }
          });
          if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
          const gist = await resp.json();
          const file = gist.files?.['ventas_data.json'];
          if (!file?.content) throw new Error("ventas_data.json no encontrado");
          const remote = JSON.parse(file.content);
          for (const s of ['branches','promoters','goals','sales']) { if (remote[s]) await this.replaceAll(s, remote[s]); }
          this.showMessage("Sincronización Exitosa", "Datos descargados de Gist.");
        } catch (e) {
          this.showMessage("Error de Sincronización", `Fallo al descargar: ${e.message}`);
        } finally {
          this.setLoading(false);
          this.renderView(this.state.currentView);
        }
      }
      async syncToGist() {
        if (!this.state.gistId || !this.state.gistToken) {
          this.showMessage("Error de Sincronización", "Configure Gist ID y Token.");
          return;
        }
        this.setLoading(true);
        try {
          const localData = {};
          for (const s of ['branches','promoters','goals','sales']) localData[s] = await this.getAll(s);
          const payload = { description: "Datos de Gestión de Ventas Local", files: { 'ventas_data.json': { content: JSON.stringify(localData, null, 2) } } };
          const resp = await fetch(`https://api.github.com/gists/${this.state.gistId}`, {
            method: 'PATCH', headers: { 'Authorization': `token ${this.state.gistToken}`, 'Content-Type':'application/json' }, body: JSON.stringify(payload)
          });
          if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
          this.showMessage("Sincronización Exitosa", "Datos locales subidos a Gist.");
        } catch (e) {
          this.showMessage("Error de Sincronización", `Fallo al subir: ${e.message}`);
        } finally {
          this.setLoading(false);
        }
      }

      // Settings + CRUD listas
      renderSettings(container) {
        container.innerHTML = `
          <section class="mb-8 p-4 border rounded-lg bg-gray-50">
            <h3 class="text-xl font-semibold mb-3 text-primary">Sincronización GitHub Gist</h3>
            <p class="text-sm text-gray-600 mb-4">Ingrese su ID de Gist y un Token con permisos 'gist'.</p>
            <form id="gist-config-form" class="space-y-4">
              <div>
                <label for="gist-id" class="block text-sm font-medium text-gray-700">Gist ID</label>
                <input type="text" id="gist-id" value="${this.state.gistId}" placeholder="Ej: a1b2c3..." class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
              </div>
              <div>
                <label for="gist-token" class="block text-sm font-medium text-gray-700">Personal Access Token</label>
                <input type="password" id="gist-token" value="${this.state.gistToken}" placeholder="ghp_XXXXXXXXXXXXXXXX" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
              </div>
              <div class="flex space-x-4 pt-2">
                <button type="submit" class="flex-1 px-4 py-2 bg-secondary text-white font-medium rounded-lg hover:bg-emerald-600 transition duration-150 flex items-center justify-center">
                  <i data-lucide="save" class="w-5 h-5 mr-2"></i> Guardar Config
                </button>
                <button type="button" onclick="app.syncFromGist()" class="flex-1 px-4 py-2 bg-accent text-white font-medium rounded-lg hover:bg-amber-600 transition duration-150 flex items-center justify-center">
                  <i data-lucide="check" class="w-5 h-5 mr-2"></i> Descargar
                </button>
                <button type="button" onclick="app.syncToGist()" class="flex-1 px-4 py-2 bg-primary text-white font-medium rounded-lg hover:bg-indigo-700 transition duration-150 flex items-center justify-center">
                  <i data-lucide="trending-up" class="w-5 h-5 mr-2"></i> Subir
                </button>
              </div>
            </form>
          </section>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <section>
              <h3 class="text-xl font-semibold mb-3 text-gray-700">Gestión de Sucursales</h3>
              <button onclick="app.showBranchForm()" class="mb-4 flex items-center px-3 py-1.5 bg-primary text-white rounded-lg hover:bg-indigo-700 text-sm">
                <i data-lucide="plus" class="w-4 h-4 mr-1"></i> Agregar Sucursal
              </button>
              <div id="branches-list" class="space-y-2"></div>
            </section>
            <section>
              <h3 class="text-xl font-semibold mb-3 text-gray-700">Gestión de Promotores</h3>
              <button onclick="app.showPromoterForm()" class="mb-4 flex items-center px-3 py-1.5 bg-primary text-white rounded-lg hover:bg-indigo-700 text-sm">
                <i data-lucide="plus" class="w-4 h-4 mr-1"></i> Agregar Promotor
              </button>
              <div id="promoters-list" class="space-y-2"></div>
            </section>
          </div>
        `;
        document.getElementById('gist-config-form').onsubmit = async (e) => {
          e.preventDefault();
          const id = document.getElementById('gist-id').value.trim();
          const tok = document.getElementById('gist-token').value.trim();
          await this.saveGistConfig(id, tok);
        };
        this.loadSettingsLists();
        window.createIcons();
      }
      async loadSettingsLists() {
        const branches = await this.getAll('branches');
        const promoters = await this.getAll('promoters');
        const branchMap = branches.reduce((m,b)=> (m[b.id]=b.name,m), {});
        const bl = document.getElementById('branches-list');
        const pl = document.getElementById('promoters-list');
        if (bl) bl.innerHTML = branches.map(b => this.renderListItem('branches', b)).join('');
        if (pl) pl.innerHTML = promoters.map(p => this.renderListItem('promoters', { ...p, branchName: branchMap[p.branchId] || 'Sin Sucursal' })).join('');
        window.createIcons();
      }
      renderListItem(storeName, item) {
        const nameDisplay = storeName === 'promoters' ? `${item.name} (${item.branchName})` : item.name;
        return `
          <div id="${storeName}-${item.id}" class="flex justify-between items-center p-3 bg-white border border-gray-200 rounded-lg shadow-sm">
            <span class="text-gray-800 font-medium truncate">${nameDisplay}</span>
            <div class="flex space-x-2">
              <button onclick="app.showEditForm('${storeName}','${item.id}')" class="text-primary hover:text-indigo-700 p-1 rounded-full bg-indigo-50 transition"><i data-lucide="edit" class="w-4 h-4"></i></button>
              <button onclick="app.deleteItem('${storeName}','${item.id}',true)" class="text-red-600 hover:text-red-800 p-1 rounded-full bg-red-50 transition"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
            </div>
          </div>
        `;
      }
      async showEditForm(storeName, id) { if (storeName==='branches') this.showBranchForm(id); else if (storeName==='promoters') this.showPromoterForm(id); }
      async deleteItem(storeName, id, reload=false) {
        if (!confirm(`¿Eliminar registro de ${storeName}?`)) return;
        try { await this.delete(storeName, id); this.showMessage("Eliminado","Registro eliminado."); if (reload) { this.loadSettingsLists(); this.renderView(this.state.currentView); } }
        catch { this.showMessage("Error","No se pudo eliminar."); }
      }
      async showBranchForm(id=null) {
        const branches = await this.getAll('branches');
        const branch = id ? branches.find(b=>b.id===id) : { id:null, name:'' };
        const title = id ? 'Editar Sucursal' : 'Agregar Nueva Sucursal';
        const body = `
          <form id="branch-form" class="space-y-4">
            <input type="hidden" id="branch-id" value="${branch.id||''}">
            <div><label for="branch-name" class="block text-sm font-medium text-gray-700">Nombre de la Sucursal</label>
            <input type="text" id="branch-name" value="${branch.name}" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border"></div>
            <div class="flex justify-end space-x-3">
              <button type="button" onclick="app.closeModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800 transition">Cancelar</button>
              <button type="submit" class="px-4 py-2 bg-primary text-white font-medium rounded-lg hover:bg-indigo-700 transition flex items-center"><i data-lucide="save" class="w-5 h-5 mr-2"></i> Guardar</button>
            </div>
          </form>`;
        this.showMessage(title, body); window.createIcons();
        document.getElementById('branch-form').onsubmit = async (e) => {
          e.preventDefault();
          const newId = document.getElementById('branch-id').value || null;
          const name = document.getElementById('branch-name').value.trim();
          if (!name) return this.showMessage("Error","El nombre es obligatorio.");
          await this.save('branches', { id:newId, name });
          this.closeModal(); this.showMessage("Guardado", `Sucursal ${name} guardada.`); this.loadSettingsLists(); this.renderView(this.state.currentView);
        };
      }
      async showPromoterForm(id=null) {
        const branches = await this.getAll('branches'); const promoters = await this.getAll('promoters');
        const promoter = id ? promoters.find(p=>p.id===id) : { id:null, name:'', branchId:'' };
        if (branches.length===0) return this.showMessage("Atención","Registre al menos una sucursal antes.");
        const title = id ? 'Editar Promotor' : 'Agregar Nuevo Promotor';
        const branchOptions = branches.map(b=>`<option value="${b.id}" ${promoter.branchId===b.id?'selected':''}>${b.name}</option>`).join('');
        const body = `
          <form id="promoter-form" class="space-y-4">
            <input type="hidden" id="promoter-id" value="${promoter.id||''}">
            <div><label for="promoter-name" class="block text-sm font-medium text-gray-700">Nombre del Promotor</label>
            <input type="text" id="promoter-name" value="${promoter.name}" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border"></div>
            <div><label for="promoter-branch" class="block text-sm font-medium text-gray-700">Asignar a Sucursal</label>
            <select id="promoter-branch" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border"><option value="">Seleccione Sucursal</option>${branchOptions}</select></div>
            <div class="flex justify-end space-x-3">
              <button type="button" onclick="app.closeModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800 transition">Cancelar</button>
              <button type="submit" class="px-4 py-2 bg-primary text-white font-medium rounded-lg hover:bg-indigo-700 transition flex items-center"><i data-lucide="save" class="w-5 h-5 mr-2"></i> Guardar</button>
            </div>
          </form>`;
        this.showMessage(title, body); window.createIcons();
        document.getElementById('promoter-form').onsubmit = async (e)=>{
          e.preventDefault();
          const newId = document.getElementById('promoter-id').value || null;
          const name = document.getElementById('promoter-name').value.trim();
          const branchId = document.getElementById('promoter-branch').value;
          if (!name || !branchId) return this.showMessage("Error","Todos los campos son obligatorios.");
          await this.save('promoters', { id:newId, name, branchId });
          this.closeModal(); this.showMessage("Guardado", `Promotor ${name} guardado.`); this.loadSettingsLists(); this.renderView(this.state.currentView);
        };
      }

      // Goals
      renderGoals(container) {
        container.innerHTML = `
          <button onclick="app.showGoalForm()" class="mb-4 flex items-center px-4 py-2 bg-primary text-white rounded-lg hover:bg-indigo-700">
            <i data-lucide="plus" class="w-5 h-5 mr-2"></i> Registrar Nueva Meta Mensual
          </button>
          <h3 class="text-xl font-semibold mb-3 text-gray-700">Metas Registradas</h3>
          <div class="table-scroll">
            <table class="min-w-full divide-y divide-gray-200">
              <thead><tr class="bg-gray-100">
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Sucursal</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Mes</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Producto</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Meta (Unid.)</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Acciones</th>
              </tr></thead>
              <tbody id="goals-tbody" class="bg-white divide-y divide-gray-200"></tbody>
            </table>
          </div>`;
        this.loadGoalsList(); window.createIcons();
      }
      async loadGoalsList() {
        const goals = await this.getAll('goals'); const branches = await this.getAll('branches');
        const branchMap = branches.reduce((m,b)=> (m[b.id]=b.name,m), {});
        const tbody = document.getElementById('goals-tbody'); if (!tbody) return;
        tbody.innerHTML = goals.sort((a,b)=> (b.createdAt||0)-(a.createdAt||0)).map(g=>`
          <tr class="hover:bg-gray-50">
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${branchMap[g.branchId]||'N/A'}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${g.month}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${g.product}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${Number(g.goal||0).toLocaleString()}</td>
            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
              <button onclick="app.showGoalForm('${g.id}')" class="text-primary hover:text-indigo-700 p-1"><i data-lucide="edit" class="w-4 h-4"></i></button>
              <button onclick="app.deleteItem('goals','${g.id}',true)" class="text-red-600 hover:text-red-800 p-1"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
            </td>
          </tr>`).join('');
        window.createIcons();
      }
      async showGoalForm(id=null) {
        const branches = await this.getAll('branches'); const goals = await this.getAll('goals');
        const goal = id ? goals.find(g=>g.id===id) : { id:null, branchId:'', month: MONTHS[new Date().getMonth()], product: PRODUCTS[0], goal:'' };
        if (branches.length===0) return this.showMessage("Atención","Debe registrar al menos una sucursal en Configuración.");
        const branchOptions = branches.map(b=>`<option value="${b.id}" ${goal.branchId===b.id?'selected':''}>${b.name}</option>`).join('');
        const monthOptions = MONTHS.map(m=>`<option value="${m}" ${goal.month===m?'selected':''}>${m}</option>`).join('');
        const productOptions = PRODUCTS.map(p=>`<option value="${p}" ${goal.product===p?'selected':''}>${p}</option>`).join('');
        const title = id ? 'Editar Meta Mensual' : 'Registrar Nueva Meta Mensual';
        const body = `
          <form id="goal-form" class="space-y-4">
            <input type="hidden" id="goal-id" value="${goal.id||''}">
            <div><label for="goal-branch" class="block text-sm font-medium text-gray-700">Sucursal</label>
              <select id="goal-branch" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">${branchOptions}</select>
            </div>
            <div><label for="goal-month" class="block text-sm font-medium text-gray-700">Mes</label>
              <select id="goal-month" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">${monthOptions}</select>
            </div>
            <div><label for="goal-product" class="block text-sm font-medium text-gray-700">Producto</label>
              <select id="goal-product" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">${productOptions}</select>
            </div>
            <div><label for="goal-quantity" class="block text-sm font-medium text-gray-700">Cantidad Meta (Unidades)</label>
              <input type="number" id="goal-quantity" value="${goal.goal||''}" min="1" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
            </div>
            <div class="flex justify-end space-x-3">
              <button type="button" onclick="app.closeModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800 transition">Cancelar</button>
              <button type="submit" class="px-4 py-2 bg-primary text-white font-medium rounded-lg hover:bg-indigo-700 transition flex items-center"><i data-lucide="save" class="w-5 h-5 mr-2"></i> Guardar Meta</button>
            </div>
          </form>`;
        this.showMessage(title, body); window.createIcons();
        document.getElementById('goal-form').onsubmit = async (e)=>{
          e.preventDefault();
          const newId = document.getElementById('goal-id').value || null;
          const data = {
            id: newId,
            branchId: document.getElementById('goal-branch').value,
            month: document.getElementById('goal-month').value,
            product: document.getElementById('goal-product').value,
            goal: parseInt(document.getElementById('goal-quantity').value, 10),
          };
          if (!data.branchId || !data.month || !data.product || isNaN(data.goal) || data.goal<=0) return this.showMessage("Error","Completa todos los campos y usa un número positivo.");
          await this.save('goals', data);
          this.closeModal(); this.showMessage("Guardado", `Meta registrada para ${data.product} en ${data.month}.`);
          this.loadGoalsList(); this.renderView('dashboard');
        };
      }

      // Sales
      renderSales(container) {
        container.innerHTML = `
          <button onclick="app.showSaleForm()" class="mb-4 flex items-center px-4 py-2 bg-secondary text-white rounded-lg hover:bg-emerald-600">
            <i data-lucide="plus" class="w-5 h-5 mr-2"></i> Registrar Venta Diaria
          </button>
          <div class="mb-4 flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
            <input type="date" id="sale-filter-date" class="p-2 border rounded-md w-full sm:w-auto">
            <select id="sale-filter-branch" class="p-2 border rounded-md w-full sm:w-auto"></select>
            <button onclick="app.loadSalesList()" class="px-3 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 text-sm">Filtrar</button>
          </div>
          <h3 class="text-xl font-semibold mb-3 text-gray-700">Ventas Registradas</h3>
          <div class="table-scroll"><table class="min-w-full divide-y divide-gray-200">
            <thead><tr class="bg-gray-100">
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Fecha</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Sucursal</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Promotor</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Producto</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Unidades</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Acciones</th>
            </tr></thead>
            <tbody id="sales-tbody" class="bg-white divide-y divide-gray-200"></tbody>
          </table></div>`;
        this.setupSalesFilters();
      }
      async setupSalesFilters() {
        const branches = await this.getAll('branches');
        const sel = document.getElementById('sale-filter-branch'); if (!sel) return;
        sel.innerHTML = `<option value="">Todas las Sucursales</option>` + branches.map(b=>`<option value="${b.id}">${b.name}</option>`).join('');
        document.getElementById('sale-filter-date').value = new Date().toISOString().split('T')[0];
        this.loadSalesList();
      }
      async loadSalesList() {
        const allSales = await this.getAll('sales'); const branches = await this.getAll('branches'); const promoters = await this.getAll('promoters');
        const branchMap = branches.reduce((m,b)=> (m[b.id]=b.name,m), {}); const promoterMap = promoters.reduce((m,p)=> (m[p.id]=p.name,m), {});
        const filterDate = document.getElementById('sale-filter-date')?.value; const filterBranchId = document.getElementById('sale-filter-branch')?.value;
        const filtered = allSales.filter(s => (!filterDate || s.date===filterDate) && (!filterBranchId || s.branchId===filterBranchId)).sort((a,b)=> new Date(b.date)-new Date(a.date));
        const tbody = document.getElementById('sales-tbody'); if (!tbody) return;
        tbody.innerHTML = filtered.map(s=>`
          <tr class="hover:bg-gray-50">
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${s.date}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${branchMap[s.branchId]||'N/A'}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${promoterMap[s.promoterId]||'N/A'}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${s.product}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${Number(s.quantity||0).toLocaleString()}</td>
            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
              <button onclick="app.showSaleForm('${s.id}')" class="text-primary hover:text-indigo-700 p-1"><i data-lucide="edit" class="w-4 h-4"></i></button>
              <button onclick="app.deleteItem('sales','${s.id}',true)" class="text-red-600 hover:text-red-800 p-1"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
            </td>
          </tr>`).join('');
        window.createIcons();
      }
      async showSaleForm(id=null) {
        const branches = await this.getAll('branches'); const promoters = await this.getAll('promoters'); const sales = await this.getAll('sales');
        const sale = id ? sales.find(s=>s.id===id) : { id:null, branchId:'', promoterId:'', date:new Date().toISOString().split('T')[0], product: PRODUCTS[0], quantity:'' };
        if (branches.length===0 || promoters.length===0) return this.showMessage("Atención","Registre Sucursales y Promotores en Configuración.");
        const branchOptions = branches.map(b=>`<option value="${b.id}" ${sale.branchId===b.id?'selected':''}>${b.name}</option>`).join('');
        const productOptions = PRODUCTS.map(p=>`<option value="${p}" ${sale.product===p?'selected':''}>${p}</option>`).join('');
        const getPromoterOptions = (selectedBranchId, selectedPromoterId) =>
          promoters.filter(p=> !selectedBranchId || p.branchId===selectedBranchId).map(p=>`<option value="${p.id}" ${selectedPromoterId===p.id?'selected':''}>${p.name}</option>`).join('');
        const title = id ? 'Editar Venta Diaria' : 'Registrar Nueva Venta Diaria';
        const body = `
          <form id="sale-form" class="space-y-4">
            <input type="hidden" id="sale-id" value="${sale.id||''}">
            <div><label for="sale-date" class="block text-sm font-medium text-gray-700">Fecha de Venta</label>
              <input type="date" id="sale-date" value="${sale.date}" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
            </div>
            <div><label for="sale-branch" class="block text-sm font-medium text-gray-700">Sucursal</label>
              <select id="sale-branch" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">${branchOptions}</select>
            </div>
            <div><label for="sale-promoter" class="block text-sm font-medium text-gray-700">Promotor</label>
              <select id="sale-promoter" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                <option value="">Seleccione Promotor</option>${getPromoterOptions(sale.branchId, sale.promoterId)}
              </select>
            </div>
            <div><label for="sale-product" class="block text-sm font-medium text-gray-700">Producto</label>
              <select id="sale-product" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">${productOptions}</select>
            </div>
            <div><label for="sale-quantity" class="block text-sm font-medium text-gray-700">Unidades Vendidas</label>
              <input type="number" id="sale-quantity" value="${sale.quantity||''}" min="1" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
            </div>
            <div class="flex justify-end space-x-3">
              <button type="button" onclick="app.closeModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800 transition">Cancelar</button>
              <button type="submit" class="px-4 py-2 bg-secondary text-white font-medium rounded-lg hover:bg-emerald-600 transition flex items-center"><i data-lucide="check" class="w-5 h-5 mr-2"></i> Registrar Venta</button>
            </div>
          </form>`;
        this.showMessage(title, body); window.createIcons();
        const promoterSelect = document.getElementById('sale-promoter');
        const branchSelect = document.getElementById('sale-branch');
        branchSelect.onchange = (e)=> { promoterSelect.innerHTML = `<option value="">Seleccione Promotor</option>` + getPromoterOptions(e.target.value, ''); };
        document.getElementById('sale-form').onsubmit = async (e)=>{
          e.preventDefault();
          const newId = document.getElementById('sale-id').value || null;
          const data = {
            id: newId,
            date: document.getElementById('sale-date').value,
            branchId: document.getElementById('sale-branch').value,
            promoterId: document.getElementById('sale-promoter').value,
            product: document.getElementById('sale-product').value,
            quantity: parseInt(document.getElementById('sale-quantity').value, 10),
          };
          if (!data.date || !data.branchId || !data.promoterId || !data.product || isNaN(data.quantity) || data.quantity<=0) return this.showMessage("Error","Completa todos los campos y usa un número positivo.");
          await this.save('sales', data);
          this.closeModal(); this.showMessage("Guardado", `Venta de ${data.quantity} unidades registrada.`);
          this.loadSalesList(); this.renderView('dashboard');
        };
      }

      // Productividad
      async renderProductivity(container) {
        const branches = await this.getAll('branches'); const promoters = await this.getAll('promoters'); const sales = await this.getAll('sales');
        const promoterSales = sales.reduce((acc,s)=> (acc[s.promoterId]=(acc[s.promoterId]||0)+ (s.quantity||0), acc), {});
        const branchMap = branches.reduce((m,b)=> (m[b.id]=b.name,m), {});
        const data = promoters.map(p => ({ ...p, branchName: branchMap[p.branchId] || 'Sin Sucursal', totalSales: promoterSales[p.id] || 0 })).sort((a,b)=> b.totalSales - a.totalSales);
        container.innerHTML = `
          <p class="mb-4 text-gray-600">Resumen de ventas por promotor en todas las sucursales.</p>
          <div class="table-scroll"><table class="min-w-full divide-y divide-gray-200">
            <thead><tr class="bg-gray-100">
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Promotor</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Sucursal</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Total Unidades Vendidas</th>
            </tr></thead>
            <tbody class="bg-white divide-y divide-gray-200">
              ${data.map(p=>`
                <tr class="hover:bg-gray-50">
                  <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${p.name}</td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${p.branchName}</td>
                  <td class="px-6 py-4 whitespace-nowrap text-lg font-semibold text-primary">${Number(p.totalSales||0).toLocaleString()}</td>
                </tr>`).join('')}
            </tbody>
          </table></div>`;
      }

      // Dashboard
      async renderDashboard(container) {
        const branches = await this.getAll('branches'); const goals = await this.getAll('goals'); const sales = await this.getAll('sales');
        const currentMonthName = MONTHS[new Date().getMonth()];
        const currentYear = new Date().getFullYear().toString();
        container.innerHTML = `
          <div id="summary-cards" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6"></div>
          <h3 class="text-xl font-semibold mb-3 text-gray-700">Avance de Metas por Producto (Global - ${currentMonthName} ${currentYear})</h3>
          <div id="product-progress" class="space-y-4 mb-6"></div>
          <h3 class="text-xl font-semibold mb-3 text-gray-700">Avance de Metas por Sucursal (${currentMonthName} ${currentYear})</h3>
          <div id="branch-progress" class="space-y-4"></div>`;
        const agg = this.aggregateSales(goals, sales, branches, currentMonthName);
        this.renderSummaryCards(agg, document.getElementById('summary-cards'));
        this.renderProductProgress(agg, document.getElementById('product-progress'));
        this.renderBranchProgress(agg, document.getElementById('branch-progress'));
        window.createIcons();
      }
      aggregateSales(goals, sales, branches, currentMonthName) {
        const gMonth = goals.filter(g=> g.month===currentMonthName);
        const sMonth = sales.filter(s=> MONTHS[new Date(s.date).getMonth()]===currentMonthName);
        const globalData = { totalGoal:0, totalSales:0 };
        const productData = {}; PRODUCTS.forEach(p=> productData[p]={goal:0, sales:0});
        const branchData = {}; branches.forEach(b=> branchData[b.id]={ name:b.name, totalGoal:0, totalSales:0 });
        gMonth.forEach(g=>{ globalData.totalGoal+=g.goal; productData[g.product].goal += g.goal; branchData[g.branchId].totalGoal += g.goal; });
        sMonth.forEach(s=>{ globalData.totalSales += s.quantity; if (productData[s.product]) productData[s.product].sales += s.quantity; if (branchData[s.branchId]) branchData[s.branchId].totalSales += s.quantity; });
        return { globalData, productData, branchData };
      }
      renderSummaryCards(agg, container) {
        const p = agg.globalData.totalGoal>0 ? Math.round((agg.globalData.totalSales/agg.globalData.totalGoal)*100) : (agg.globalData.totalSales>0?100:0);
        const color = p>=100 ? 'secondary' : (p>=75 ? 'accent' : 'red-500');
        const cards = [
          { title:"Meta Global Mensual", value: Number(agg.globalData.totalGoal||0).toLocaleString(), icon:"target", color:"primary" },
          { title:"Ventas Totales Mensuales", value: Number(agg.globalData.totalSales||0).toLocaleString(), icon:"trending-up", color:"secondary" },
          { title:"Avance Global (%)", value: `${p}%`, icon:"check", color },
        ];
        container.innerHTML = cards.map(card => `
          <div class="bg-white p-4 rounded-xl shadow-md border-l-4 border-${card.color.replace(/-.*/,'')}-500">
            <div class="flex items-center justify-between">
              <p class="text-sm font-medium text-gray-500">${card.title}</p>
              <i data-lucide="${card.icon}" class="w-6 h-6 text-${card.color.replace(/-.*/,'')}-500"></i>
            </div>
            <p class="mt-1 text-2xl font-bold text-gray-900">${card.value}</p>
          </div>`).join('');
      }
      renderProductProgress(agg, container) {
        const entries = Object.entries(agg.productData);
        container.innerHTML = entries.map(([product,d])=>{
          const goal=d.goal, sales=d.sales, progress = goal>0? Math.round((sales/goal)*100):(sales>0?100:0); const safe=Math.min(100,progress);
          const barColor = progress>=100 ? 'bg-secondary' : 'bg-primary';
          return `
            <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
              <div class="flex justify-between items-center mb-2">
                <span class="font-medium text-gray-800">${product.toUpperCase()}</span>
                <span class="text-sm font-semibold text-gray-700">${Number(sales||0).toLocaleString()} / ${Number(goal||0).toLocaleString()} (${progress}%)</span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-3"><div class="h-3 rounded-full ${barColor}" style="width:${safe}%"></div></div>
            </div>`;
        }).join('') || '<p class="text-gray-500">No hay metas ni ventas registradas para el mes actual.</p>';
      }
      renderBranchProgress(agg, container) {
        const entries = Object.entries(agg.branchData);
        container.innerHTML = entries.map(([id,d])=>{
          const goal=d.totalGoal, sales=d.totalSales, progress = goal>0? Math.round((sales/goal)*100):(sales>0?100:0); const safe=Math.min(100,progress);
          const barColor = progress>=100 ? 'bg-secondary' : 'bg-primary';
          return `
            <div class="p-4 bg-white rounded-xl shadow-sm border border-gray-200">
              <div class="flex justify-between items-center mb-2">
                <span class="text-lg font-bold text-primary">${d.name}</span>
                <span class="text-md font-semibold text-gray-700">${Number(sales||0).toLocaleString()} / ${Number(goal||0).toLocaleString()} (${progress}%)</span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-4"><div class="h-4 rounded-full ${barColor}" style="width:${safe}%"></div></div>
            </div>`;
        }).join('') || '<p class="text-gray-500">No hay sucursales registradas o sin datos.</p>';
      }

      // Inicio independiente de Gist
      async init() {
        await registerSW();
        await prewarmCache(['./', 'https://cdn.tailwindcss.com', 'https://unpkg.com/lucide@latest']);
        await this.initDB();
        await this.loadGistConfigLocal(); // solo lee config local si existe
        this.state.isReady = true;
        this.renderView('dashboard');
      }
    }

    // Arranque
    const app = new SalesApp();
    window.app = app;
    app.init();
  </script>
</body>
</html>
